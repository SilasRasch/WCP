@using WCPAdminFrontEnd.Services
@using WCPShared.Models.Views
@using WCPShared.Services.EntityFramework
@inject OrderService OrderService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @Project.ProjectName ny status (@ProjectHelper.GetStatusString(NewStatus))
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Row="true">
            <MudTextField Value="@Project.Id.ToString()" Label="Projekt ID" ReadOnly="true" />
            <MudTextField Value="@Project.ProjectName" Label="Projektnavn" ReadOnly="true" />
        </MudStack>

        @* From unconfirmed to confirmed *@
        @if (Project.Status == 0 && NewStatus == 1)
        {
            <MudStack Row="true">
                <MudTextField @bind-Value="Project.Price" Label="Pris" Placeholder="Pris eksl. moms" Immediate="true"></MudTextField>
            </MudStack>

            <MudStack Row="true">
                <MudDatePicker @bind-Date="_deliveryDate" Label="Leveringsdato" Placeholder="Estimeret leveringsdato"></MudDatePicker>
            </MudStack>
        }

        @* From queued to planned *@
        @if (Project.Status == 1 && NewStatus == 2)
        {
            <MudTextField @bind-Value="Project.Scripts" Label="Scripts" Placeholder="Link til script-mappe" Immediate="true"></MudTextField>
            <MudTextField @bind-Value="Project.Content" Label="Content" Placeholder="Link til content-mappe" Immediate="true"></MudTextField>
            <MudTextField @bind-Value="Project.Delivery" Label="Levering" Placeholder="Link til afleverings-mappe" Immediate="true"></MudTextField>
            <MudTextField @bind-Value="Project.Other" Label="Andet" Placeholder="Link til mappe" Immediate="true"></MudTextField>
        }

    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Error"><MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" /> Annuller</MudButton>
        <MudButton OnClick="Submit" Color="Color.Success"><MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" /> Bekræft</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public OrderView Project { get; set; } = new();

    [Parameter]
    public int NewStatus { get; set; }

    private DateTime? _deliveryDate;

    private async void Submit()
    {
        Project.Status = NewStatus;

        if (_deliveryDate is not null)
        {
            Project.DeliveryDate = _deliveryDate!.Value.AddHours(23).AddMinutes(59).AddSeconds(59);
        }
        

        await OrderService.UpdateObject(Project.Id, Project.ToDto());
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();
}

