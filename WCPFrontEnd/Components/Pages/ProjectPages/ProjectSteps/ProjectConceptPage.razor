@using Microsoft.EntityFrameworkCore
@using WCPAdminFrontEnd.Services
@using WCPFrontEnd.Components.Shared
@using WCPShared.Interfaces
@using WCPShared.Models.Entities
@using WCPShared.Models.Entities.ProjectModels
@using WCPShared.Models.Entities.ProjectModels.Concepts
@using WCPShared.Models.Entities.UserModels
@inject IDialogService DialogService

@foreach (var concept in Project.Concepts) 
{
    <MudPaper Class="pa-4">
        <MudStack Spacing="0">
            <MudStack Row>
                <MudText Typo="Typo.h6">Koncept @(Project.Concepts.IndexOf(concept) + 1)</MudText>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => Project.Concepts.Remove(concept)" />
            </MudStack>

            <MudStack Spacing="4" Class="mt-4">

                <MudSelect Required Label="Produkt" @bind-Value="concept.Product" Clearable Text="@ProductToString(concept.Product)" ToStringFunc="ProductToString" AnchorOrigin="Origin.BottomCenter">
                    @foreach (Product product in Products)
                    {
                        <MudSelectItem Value="@product" Class="p-2 cursor-pointer text-primary">@product.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudButton OnClick="() => OpenAddProductDialog(concept)">Tilføj nyt produkt</MudButton>

                @if (concept is CreatorConcept creatorConcept)
                {
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption">Må creator beholde produktet?</MudText>

                        <MudStack>
                            <MudButton @onclick="() => creatorConcept.CreatorKeepsProduct = !creatorConcept.CreatorKeepsProduct" Color="@(creatorConcept.CreatorKeepsProduct ? Color.Success : Color.Primary)"
                                       Variant="Variant.Filled" Class="text-white rounded-lg" Spacing="0" Row Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                                <MudText>@(creatorConcept.CreatorKeepsProduct ? "Ja - giv en anslået værdi" : "Nej - husk at sende returlabel med")</MudText>
                            </MudButton>

                            @if (concept.Product is not null && creatorConcept.CreatorKeepsProduct)
                            {
                                <MudTextField Label="Anslået værdi" @bind-Value="creatorConcept.Product.Value" Required RequiredError="Dette felt er påkrævet" />
                            }
                        </MudStack>
                    </MudStack>
                }
            </MudStack>

            <MudStack Row Spacing="8" AlignItems="AlignItems.Center" Justify="Justify.Center" Class="mt-4">
                <MudSelect T="string" MultiSelection @bind-Text="concept.Platforms" Label="Tiltænkte platforme" Placeholder="Alle tiltænkte platforme" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("TikTok")">TikTok</MudSelectItem>
                    <MudSelectItem Value="@("Instagram")">Instagram</MudSelectItem>
                    <MudSelectItem Value="@("Facebook")">Facebook</MudSelectItem>
                    <MudSelectItem Value="@("YouTube")">YouTube</MudSelectItem>
                    <MudSelectItem Value="@("Snapchat")">Snapchat</MudSelectItem>
                </MudSelect>
            </MudStack>

            <MudStack Spacing="0" AlignItems="AlignItems.Center" Class="w-full h-full">
                <MudSlider T="int" ValueLabel Size="Size.Medium" @bind-Value="concept.Amount" Min="1" Max="16" Color="Color.Primary">
                    <ValueLabelContent>
                        @(context.Value > 0 ? $"{context.Value} stk" : "Nej")
                    </ValueLabelContent>
                    <ChildContent>
                        <MudText Typo="Typo.caption">Mængde</MudText>
                    </ChildContent>
                </MudSlider>
                <MudText Class="opacity-75">@(concept.Amount > 0 ? $"{concept.Amount} stk" : "Nej")</MudText>
            </MudStack>

            <MudStack>
                @if (concept is UgcConcept ugcConcept)
                {
                    <MudStack Spacing="8" Row AlignItems="AlignItems.End" Justify="Justify.Center">
                        <MudStack Spacing="0" AlignItems="AlignItems.Center" Class="w-full h-full">
                            <MudSlider T="int" ValueLabel Size="Size.Medium" @bind-Value="ugcConcept.LengthInSeconds" Min="15" Max="90" Step="5" Color="Color.Primary">
                                <ValueLabelContent>
                                    @context.Value sek
                                </ValueLabelContent>
                                <ChildContent>
                                    <MudText Typo="Typo.caption">Længde</MudText>
                                </ChildContent>
                            </MudSlider>
                            <MudText Class="opacity-75">@ugcConcept.LengthInSeconds sekunder</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.Center" Class="w-full h-full">
                            <MudSlider T="int" ValueLabel Size="Size.Medium" @bind-Value="ugcConcept.ExtraHooks" Min="0" Max="100" Color="Color.Primary">
                                <ValueLabelContent>
                                    @(context.Value > 0 ? $"{context.Value} stk" : "Nej")
                                </ValueLabelContent>
                                <ChildContent>
                                    <MudText Typo="Typo.caption">Ekstra hooks</MudText>
                                </ChildContent>
                            </MudSlider>
                            <MudText Class="opacity-75">@(ugcConcept.ExtraHooks > 0 ? $"{ugcConcept.ExtraHooks} stk" : "Nej")</MudText>
                        </MudStack>
                    </MudStack>
                }
            </MudStack>

            <MudStack Justify="Justify.FlexStart" Class="mt-2">
                <MudText>Formater*</MudText>
                <MudStack Row>
                    <MudPaper Elevation="0">
                        <MudButton OnClick="@(() => ToggleFormat("16:9", concept))" Variant="Variant.Filled" Color="Color.Secondary"
                                   Class="@(concept.Formats.Contains("16:9") ? "w-[144px] h-[256px] mud-secondary brightness-90" : "w-[144px] h-[256px] mud-secondary")">
                            <MudStack Class="h-full w-full mud-text-primary" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudText Typo="Typo.h6">16:9</MudText>
                            </MudStack>
                        </MudButton>
                    </MudPaper>

                    <MudPaper Elevation="0">
                        <MudButton OnClick="@(() => ToggleFormat("4:5", concept))" Variant="Variant.Filled" Color="Color.Secondary"
                                   Class="@(concept.Formats.Contains("4:5") ? "w-[144px] h-[180px] mud-secondary brightness-90" : "w-[144px] h-[180px] mud-secondary")">
                            <MudStack Class="h-full w-full mud-text-primary" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudText Typo="Typo.h6">4:5</MudText>
                            </MudStack>
                        </MudButton>
                    </MudPaper>

                    <MudPaper Elevation="0">
                        <MudButton OnClick="@(() => ToggleFormat("1:1", concept))" Variant="Variant.Filled" Color="Color.Secondary"
                                   Class="@(concept.Formats.Contains("1:1") ? "w-[144px] h-[144px] mud-secondary brightness-90" : "w-[144px] h-[144px] mud-secondary")">
                            <MudStack Class="h-full w-full mud-text-primary" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudText Typo="Typo.h6">1:1</MudText>
                            </MudStack>
                        </MudButton>
                    </MudPaper>

                    @if (concept is UgcConcept)
                    {
                        <MudPaper Elevation="0">
                            <MudButton OnClick="@(() => ToggleFormat("Uden captions", concept))" Variant="Variant.Filled" Color="Color.Secondary"
                                       Class="@(concept.Formats.Contains("Uden captions") ? "w-[216px] h-[144px] mud-secondary brightness-90" : "w-[216px] h-[144px] mud-secondary")">
                                <MudStack Class="h-full w-full mud-text-primary" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                    <MudText Typo="Typo.h6">Uden captions</MudText>
                                </MudStack>
                            </MudButton>
                        </MudPaper>
                    }
                </MudStack>
            </MudStack>

            @if (concept is CreatorConcept creatorConcept)
            {
                <MudText Class="text-center" Typo="Typo.h6">Creator</MudText>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudStack Spacing="8" Row>
                            <LanguageSelector Label="Sprog" @bind-Value="creatorConcept.CreatorLanguage" Languages="Languages" />
                            <MudSelect Label="Køn" @bind-Value="creatorConcept.CreatorGender" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@("Male")">Mand</MudSelectItem>
                                <MudSelectItem Value="@("Female")">Kvinde</MudSelectItem>
                                <MudSelectItem Value="@("None")">Ikke vigtigt</MudSelectItem>
                                <MudSelectItem Value="@("Other")">Andet</MudSelectItem>
                            </MudSelect>
                        </MudStack>
                        <MudStack Spacing="8" Row>
                            <MudSelect Label="Alder" @bind-Value="creatorConcept.CreatorAge" ToStringFunc="ProjectHelper.ArrayToStringFunc" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@(new int[] { 18, 24 })">18-24</MudSelectItem>
                                <MudSelectItem Value="@(new int[] { 25, 30 })">25-30</MudSelectItem>
                                <MudSelectItem Value="@(new int[] { 31, 40 })" >31-40</MudSelectItem>
                                <MudSelectItem Value="@(new int[] { 40 })">40+</MudSelectItem>
                            </MudSelect>
                            <MudSelect Label="Budget" @bind-Value="creatorConcept.CreatorBudget" ToStringFunc="ProjectHelper.LongArrayToStringFunc" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@(new long[] { 150, 250 })">150-250</MudSelectItem>
                                <MudSelectItem Value="@(new long[] { 250, 350 })">250-350</MudSelectItem>
                                <MudSelectItem Value="@(new long[] { 350, 500 })">350-500</MudSelectItem>
                                <MudSelectItem Value="@(new long[] { 500, 700 })">500-700</MudSelectItem>
                                <MudSelectItem Value="@(new long[] { 700 })">700+</MudSelectItem>
                            </MudSelect>
                        </MudStack>
                        <MudStack Spacing="8" Row>
                            <MudStack Spacing="0" AlignItems="AlignItems.Center" Class="w-full h-full">
                                <MudSlider T="int" ValueLabel Size="Size.Medium" @bind-Value="creatorConcept.CreatorCount" Min="1" Max="creatorConcept.Amount" Color="Color.Primary">
                                    <ValueLabelContent>
                                        @context.Value.ToString()
                                    </ValueLabelContent>
                                    <ChildContent>
                                        <MudText Typo="Typo.caption">Antal creators</MudText>
                                    </ChildContent>
                                </MudSlider>
                                <MudText Class="opacity-75">@creatorConcept.CreatorCount creators</MudText>
                            </MudStack>
                            <MudStack Spacing="0" AlignItems="AlignItems.Center" Class="w-full h-full">
                                <MudSlider T="int" ValueLabel Size="Size.Medium" @bind-Value="creatorConcept.CreativesPerCreator" Min="1" Max="@(creatorConcept.Amount / creatorConcept.CreatorCount)" Color="Color.Primary">
                                    <ValueLabelContent>
                                        @context.Value.ToString()
                                    </ValueLabelContent>
                                    <ChildContent>
                                        <MudText Typo="Typo.caption">Kreativer per creator</MudText>
                                    </ChildContent>
                                </MudSlider>
                                <MudText Class="opacity-75">@creatorConcept.CreativesPerCreator per creator</MudText>
                            </MudStack>
                        </MudStack>
                    <MudSelect MultiSelection @bind-SelectedValues="creatorConcept.Tags" Label="Kategori" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@("Beauty")">Beauty</MudSelectItem>
                            <MudSelectItem Value="@("Fashion")">Fashion</MudSelectItem>
                            <MudSelectItem Value="@("Home")">Home</MudSelectItem>
                            <MudSelectItem Value="@("Lifestyle")">Lifestyle</MudSelectItem>
                            <MudSelectItem Value="@("Technology")">Technology</MudSelectItem>
                        </MudSelect>
                    </MudStack>
            }
        </MudStack>
    </MudPaper>
    
}


@code {
    [Parameter]
    public IWcpDbContext Context { get; set; }

    [Parameter]
    public Project Project
    {
        get { return _project; }
        set
        {
            if (_project == value) return;

            _project = value;
            ProjectChanged.InvokeAsync(value);
        }
    }

    [Parameter]
    public EventCallback<Project> ProjectChanged { get; set; }
    private Project _project;

    private MudSelect<Product> productSelect;
    private IEnumerable<Product> Products = [];

    protected override async Task OnInitializedAsync()
    {
        if (Project.Brand is not null)
        {
            Products = await Context.Products.Where(x => x.BrandId == Project.Brand.Id).ToListAsync();
            Languages = await Context.Languages.ToListAsync();
        }
    }

    private async Task OpenAddProductDialog(Concept concept)
    {
        // await productSelect.CloseMenu();
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var parameters = new DialogParameters<WCPFrontEnd.Components.Pages.ProductRelated.Dialoges.AddProductDialog>
        {
            { x => x.Brand, Project.Brand }
        };

        var dialog = await DialogService.ShowAsync<WCPFrontEnd.Components.Pages.ProductRelated.Dialoges.AddProductDialog>("Add product dialog", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Product addedProduct)
        {
            concept.Product = addedProduct;
            Products = await Context.Products.Where(x => x.BrandId == Project.Brand.Id).AsNoTracking().ToListAsync();
        }
    }

    private string ProductToString(Product product) => product is not null ? product.Name : string.Empty;

    private void ToggleFormat(string format, Concept concept)
    {
        if (!concept.Formats.Contains(format)) concept.Formats.Add(format);
        else concept.Formats.Remove(format);
    }

    private IEnumerable<Language> Languages = [];
}
