@page "/login"
@attribute [ExcludeFromInteractiveRouting]
@using Microsoft.EntityFrameworkCore
@using WCPFrontEnd.Services
@using WCPShared.Models.Entities
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using WCPShared.Interfaces
@using WCPShared.Models.Entities.AuthModels
@using WCPShared.Models.Entities.UserModels
@using WCPShared.Models.Enums
@using WCPShared.Services
@inject NavigationManager NavigationManager
@inject IWcpDbContext Context
@inject StripeService StripeService
@inject ApplicationState ApplicationState

<MudGrid Class="absolute top-0 left-0 min-h-[100vh] overflow-hidden" Spacing="0">
    <MudItem xs="6">
        <MudStack Spacing="1" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="h-full">
            <MudImage Src="https://wc-files.se-sto-1.linodeobjects.com/media/wc-logo.png" Height="28" Class="max-h-[48px] my-6" Alt="WebContent logo" />
            <h1 class="text-[2.5em] font-medium">Velkommen tilbage</h1>
            <h1 class="text-[16px] text-neutral-400">Vi har savnet dig!</h1>
            <EditForm Model="@Model" OnValidSubmit="Authenticate" FormName="LoginForm" class="w-full max-w-[360px] flex flex-column gap-2 mt-4 mb-2">
                <DataAnnotationsValidator />
                <div class="grid w-full">
                    <span>Email</span>
                    <InputText type="email" @bind-Value="Model.Email" class="p-2 rounded-lg w-full border border-border" />
                    <ValidationMessage For="() => Model.Email" class="text-red-600" />
                </div>
                <div class="grid w-full">
                    <span>Kode</span>
                    <InputText type="password" @bind-Value="Model.Password" class="p-2 rounded-lg w-full border border-border" />
                    <ValidationMessage For="() => Model.Password" class="text-red-600" />
                </div>

                @if (errorMessage is not null)
                {
                    <span class="text-red-600 mt-2">@errorMessage</span>
                }

                <hr />

                <button type="submit" class="rounded-lg p-2 bg-primary-500 text-white hover:bg-primary-600 duration-200 w-full">Login</button>
            </EditForm>
            @* <span>Har du ikke en bruger? Registrer dig her</span> *@
        </MudStack>
        
    </MudItem>
    <MudItem xs="6" Class="bg-primary-600 overflow-hidden">
        <div class="relative h-full w-full flex flex-column align-items-center bg-transparent overflow-hidden">
            <h1 class="text-[3.5em] font-bold leading-none text-white pt-24 px-24">Creators og brands forenet på samme Platform</h1>
            <h1 class="text-[2em] leading-tight text-white px-24 mt-6">Transformér dine projekter med den ultimative platform til kollaboration.</h1>

            <MudPaper Elevation="21" Class="w-[300px] absolute left-16 bottom-64 z-40">
                <MudText Typo="Typo.h6" Class="pa-4">Projekt status</MudText>
                <MudDivider />
                <MudChart ChartType="ChartType.Donut" Height="250px" InputData="@donutData" InputLabels="@donutLabels" ChartOptions="new ChartOptions() { }">
                    <CustomGraphics>
                        <text class="donut-inner-text" x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-family="Helvetica" font-size="2">Total</text>
                        <text class="donut-inner-text" x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Helvetica" font-size="5">12</text>
                    </CustomGraphics>
                </MudChart>
            </MudPaper>

            <MudPaper Class="pa-4 absolute right-16 top-96 z-40" Width="25%" Elevation="21">
                <MudStack Row AlignItems="AlignItems.Center" Class="w-full">
                    <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Class=" h-[48px] aspect-square rounded-lg bg-yellow-200 flex">
                        <MudIcon Size="Size.Large" Icon="@Icons.Material.Filled.Star" Class="text-yellow-700"></MudIcon>
                    </MudStack>
                    <MudStack Spacing="0" Class="w-full">
                        <MudText Class="text-neutral-400">Total projekter</MudText>

                        <MudStack Row Class="w-full" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h5">08</MudText>
                            <span class="text-xs font-semibold bg-success-50 text-success-400 h-fit rounded-lg py-[2px] px-[6px]">+25%</span>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <MudImage Src="https://wc-files.se-sto-1.linodeobjects.com/media/f20f8d5a4a4522bbc01c3dc175ec1a6f.png" Class="rounded-xl border-8 border-neutral-900 absolute max-w-[50vw] z-30 -right-64 -bottom-6 overflow-hidden" Alt="WebContent Dashboard" />
        </div>
    </MudItem>
</MudGrid>

@code {
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    [SupplyParameterFromForm]
    public UserDto Model { get; set; } = new();
    private string? errorMessage;

    private MudForm _form;
    private bool _success;
    private string[] _errors = { };

    public string[] donutLabels = { "I gang", "Færdig", "Afventer" };
    public double[] donutData = { 3, 3, 6 };

    private async Task Authenticate()
    {
        User? user = await Context.Users
            .Include(x => x.Organization)
            .SingleOrDefaultAsync(x => x.Email == Model.Email);

        if (user is null || !BCrypt.Net.BCrypt.Verify(Model.Password, user.PasswordHash)) 
        {
            errorMessage = "Invalid email or password";
            return;
        }

        if (!user.IsActive)
        {
            errorMessage = "User deactivated";
            return;
        }

        List<Claim> claims = new List<Claim>()
        {
            new Claim("Id", user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Name, user.Name),
            new Claim(ClaimTypes.Role, user.Role.ToString()),
        };

        if (user.Role == UserRole.Bruger && (user.Organization is null || !user.Organization.IsActive || string.IsNullOrEmpty(user.Organization.StripeAccountId)))
            claims.Add(new Claim("IsNotSubscribed", string.Empty));
        else if (user.Role == UserRole.Bruger && (user.Organization is not null && user.Organization.IsActive && !string.IsNullOrEmpty(user.Organization.StripeAccountId)))
            claims.Add(new Claim("StripeAccountId", user.Organization.StripeAccountId));

        if (user.Role == UserRole.Creator) 
        {
            Creator? creator = await Context.Creators.SingleOrDefaultAsync(x => x.UserId == user.Id);
            if (creator is not null) 
            {
                if (string.IsNullOrEmpty(creator.StripeAccountId))
                    claims.Add(new Claim("IsNotStripeConnected", string.Empty));
                else {
                    claims.Add(new Claim("StripeAccountId", creator.StripeAccountId));

                    // Display onboarding incomplete
                    if (!await StripeService.CheckOnboardingStatus(creator.StripeAccountId)) 
                    {
                        claims.Add(new Claim("OnboardingIncomplete", string.Empty));
                    }
                }

                claims.Add(new Claim("SubType", creator.SubType.ToString()));
                claims.Add(new Claim("CreatorId", creator.Id.ToString()));
            }
        }

        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);
        ApplicationState.UnloadData();
        await HttpContext!.SignInAsync(principal);

        NavigationManager.NavigateTo("/");
    }
}